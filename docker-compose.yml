services:
  # PostgreSQL with PostGIS Extension
  postgres:
    image: postgis/postgis:16-3.4
    container_name: mobility-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-mobility_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-mobility_password}
      POSTGRES_DB: ${POSTGRES_DB:-mobility_platform}
      POSTGRES_MULTIPLE_DATABASES: user_service,vehicle_service,booking_service,pricing_service,payment_service,location_service,review_service,driver_service,maintenance_service
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./infrastructure/docker/postgres/init:/docker-entrypoint-initdb.d
    networks:
      - mobility-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-mobility_user} -d ${POSTGRES_DB:-mobility_platform}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # RabbitMQ Message Broker
  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: mobility-rabbitmq
    restart: unless-stopped
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-mobility_user}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-mobility_password}
      RABBITMQ_DEFAULT_VHOST: ${RABBITMQ_VHOST:-mobility_vhost}
      RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS: -rabbit log_levels [{connection,error},{default,error}] disk_free_limit 2147483648
    ports:
      - "${RABBITMQ_PORT:-5672}:5672"      # AMQP port
      - "${RABBITMQ_MANAGEMENT_PORT:-15672}:15672"  # Management UI
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
      - rabbitmq_logs:/var/log/rabbitmq
      - ./infrastructure/docker/rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf
      - ./infrastructure/docker/rabbitmq/definitions.json:/etc/rabbitmq/definitions.json
    networks:
      - mobility-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache
  redis:
    image: redis:7.2-alpine
    container_name: mobility-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD:-mobility_redis_password} --maxmemory 512mb --maxmemory-policy allkeys-lru --appendonly yes
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
      - ./infrastructure/docker/redis/redis.conf:/usr/local/etc/redis/redis.conf
    networks:
      - mobility-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL Admin Tool (pgAdmin) - Optional
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: mobility-pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@mobility.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin_password}
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'
    ports:
      - "${PGADMIN_PORT:-5050}:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - mobility-network
    depends_on:
      - postgres
    profiles:
      - admin-tools

  # Redis Commander - Optional
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: mobility-redis-commander
    restart: unless-stopped
    environment:
      REDIS_HOSTS: local:redis:6379:0:${REDIS_PASSWORD:-mobility_redis_password}
    ports:
      - "${REDIS_COMMANDER_PORT:-8081}:8081"
    networks:
      - mobility-network
    depends_on:
      - redis
    profiles:
      - admin-tools

  # ============================================
  # BACKEND SERVICES
  # ============================================

  # Eureka Server - Service Discovery (must start first)
  eureka-server:
    build:
      context: ./backend
      dockerfile: eureka-server/Dockerfile
    container_name: mobility-eureka-server
    restart: unless-stopped
    ports:
      - "8761:8761"
    networks:
      - mobility-network
    environment:
      - SERVER_PORT=8761
      - EUREKA_HOSTNAME=eureka-server
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8761/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    profiles:
      - backend

  # API Gateway
  api-gateway:
    build:
      context: ./backend
      dockerfile: api-gateway/Dockerfile
    container_name: mobility-api-gateway
    restart: unless-stopped
    ports:
      - "8080:8080"
    networks:
      - mobility-network
    environment:
      - SERVER_PORT=8080
      - EUREKA_SERVER=http://eureka-server:8761/eureka/
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USERNAME=${POSTGRES_USER:-mobility_user}
      - DB_PASSWORD=${POSTGRES_PASSWORD:-mobility_password}
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USERNAME=${RABBITMQ_USER:-mobility_user}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-mobility_password}
      - RABBITMQ_VHOST=${RABBITMQ_VHOST:-mobility_vhost}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-mobility_redis_password}
    depends_on:
      eureka-server:
        condition: service_healthy
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    profiles:
      - backend

  # User Service
  user-service:
    build:
      context: ./backend
      dockerfile: user-service/Dockerfile
    container_name: mobility-user-service
    restart: unless-stopped
    ports:
      - "8081:8081"
    networks:
      - mobility-network
    environment:
      - SERVER_PORT=8081
      - EUREKA_SERVER=http://eureka-server:8761/eureka/
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USERNAME=${POSTGRES_USER:-mobility_user}
      - DB_PASSWORD=${POSTGRES_PASSWORD:-mobility_password}
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USERNAME=${RABBITMQ_USER:-mobility_user}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-mobility_password}
      - RABBITMQ_VHOST=${RABBITMQ_VHOST:-mobility_vhost}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-mobility_redis_password}
      - JWT_SECRET=${JWT_SECRET:-mobility-platform-secret-key-minimum-256-bits-long-for-security}
    depends_on:
      eureka-server:
        condition: service_healthy
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8081/api/users/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    profiles:
      - backend

  # Vehicle Service
  vehicle-service:
    build:
      context: ./backend
      dockerfile: vehicle-service/Dockerfile
    container_name: mobility-vehicle-service
    restart: unless-stopped
    ports:
      - "8082:8082"
    networks:
      - mobility-network
    environment:
      - SERVER_PORT=8082
      - EUREKA_SERVER=http://eureka-server:8761/eureka/
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USERNAME=${POSTGRES_USER:-mobility_user}
      - DB_PASSWORD=${POSTGRES_PASSWORD:-mobility_password}
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USERNAME=${RABBITMQ_USER:-mobility_user}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-mobility_password}
      - RABBITMQ_VHOST=${RABBITMQ_VHOST:-mobility_vhost}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-mobility_redis_password}
    depends_on:
      eureka-server:
        condition: service_healthy
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8082/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    profiles:
      - backend

  # Booking Service
  booking-service:
    build:
      context: ./backend
      dockerfile: booking-service/Dockerfile
    container_name: mobility-booking-service
    restart: unless-stopped
    ports:
      - "8083:8083"
    networks:
      - mobility-network
    environment:
      - SERVER_PORT=8083
      - EUREKA_SERVER=http://eureka-server:8761/eureka/
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USERNAME=${POSTGRES_USER:-mobility_user}
      - DB_PASSWORD=${POSTGRES_PASSWORD:-mobility_password}
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USERNAME=${RABBITMQ_USER:-mobility_user}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-mobility_password}
      - RABBITMQ_VHOST=${RABBITMQ_VHOST:-mobility_vhost}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-mobility_redis_password}
      - PAYMENT_GATEWAY_URL=http://payment-gateway:8089/api
      - PAYMENT_GATEWAY_TOKEN=8f3A9cKpQ2Lw7ZxR6M4HnB5JdE
    depends_on:
      eureka-server:
        condition: service_healthy
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
      payment-gateway:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8083/api/bookings/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    profiles:
      - backend

  # Pricing Service
  pricing-service:
    build:
      context: ./backend
      dockerfile: pricing-service/Dockerfile
    container_name: mobility-pricing-service
    restart: unless-stopped
    ports:
      - "8084:8084"
    networks:
      - mobility-network
    environment:
      - SERVER_PORT=8084
      - EUREKA_SERVER=http://eureka-server:8761/eureka/
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USERNAME=${POSTGRES_USER:-mobility_user}
      - DB_PASSWORD=${POSTGRES_PASSWORD:-mobility_password}
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USERNAME=${RABBITMQ_USER:-mobility_user}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-mobility_password}
      - RABBITMQ_VHOST=${RABBITMQ_VHOST:-mobility_vhost}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-mobility_redis_password}
    depends_on:
      eureka-server:
        condition: service_healthy
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8084/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    profiles:
      - backend

  # Driver Service
  driver-service:
    build:
      context: ./backend
      dockerfile: driver-service/Dockerfile
    container_name: mobility-driver-service
    restart: unless-stopped
    ports:
      - "8085:8085"
    networks:
      - mobility-network
    environment:
      - SERVER_PORT=8085
      - EUREKA_SERVER=http://eureka-server:8761/eureka/
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USERNAME=${POSTGRES_USER:-mobility_user}
      - DB_PASSWORD=${POSTGRES_PASSWORD:-mobility_password}
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USERNAME=${RABBITMQ_USER:-mobility_user}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-mobility_password}
      - RABBITMQ_VHOST=${RABBITMQ_VHOST:-mobility_vhost}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-mobility_redis_password}
    depends_on:
      eureka-server:
        condition: service_healthy
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8085/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    profiles:
      - backend

  # Review Service
  review-service:
    build:
      context: ./backend
      dockerfile: review-service/Dockerfile
    container_name: mobility-review-service
    restart: unless-stopped
    ports:
      - "8086:8086"
    networks:
      - mobility-network
    environment:
      - SERVER_PORT=8086
      - EUREKA_SERVER=http://eureka-server:8761/eureka/
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USERNAME=${POSTGRES_USER:-mobility_user}
      - DB_PASSWORD=${POSTGRES_PASSWORD:-mobility_password}
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USERNAME=${RABBITMQ_USER:-mobility_user}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-mobility_password}
      - RABBITMQ_VHOST=${RABBITMQ_VHOST:-mobility_vhost}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-mobility_redis_password}
    depends_on:
      eureka-server:
        condition: service_healthy
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8086/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    profiles:
      - backend

  # Location Service
  location-service:
    build:
      context: ./backend
      dockerfile: location-service/Dockerfile
    container_name: mobility-location-service
    restart: unless-stopped
    ports:
      - "8087:8087"
    networks:
      - mobility-network
    environment:
      - SERVER_PORT=8087
      - EUREKA_SERVER=http://eureka-server:8761/eureka/
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USERNAME=${POSTGRES_USER:-mobility_user}
      - DB_PASSWORD=${POSTGRES_PASSWORD:-mobility_password}
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USERNAME=${RABBITMQ_USER:-mobility_user}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-mobility_password}
      - RABBITMQ_VHOST=${RABBITMQ_VHOST:-mobility_vhost}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-mobility_redis_password}
    depends_on:
      eureka-server:
        condition: service_healthy
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8087/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    profiles:
      - backend

  # Maintenance Service
  maintenance-service:
    build:
      context: ./backend
      dockerfile: maintenance-service/Dockerfile
    container_name: mobility-maintenance-service
    restart: unless-stopped
    ports:
      - "8088:8088"
    networks:
      - mobility-network
    environment:
      - SERVER_PORT=8088
      - EUREKA_SERVER=http://eureka-server:8761/eureka/
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USERNAME=${POSTGRES_USER:-mobility_user}
      - DB_PASSWORD=${POSTGRES_PASSWORD:-mobility_password}
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USERNAME=${RABBITMQ_USER:-mobility_user}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-mobility_password}
      - RABBITMQ_VHOST=${RABBITMQ_VHOST:-mobility_vhost}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-mobility_redis_password}
    depends_on:
      eureka-server:
        condition: service_healthy
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8088/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    profiles:
      - backend

  # Payment Gateway (Internal)
  payment-gateway:
    build:
      context: ./backend
      dockerfile: internal-payment-gateway/Dockerfile
    container_name: mobility-payment-gateway
    restart: unless-stopped
    ports:
      - "8089:8089"
    networks:
      - mobility-network
    environment:
      - SERVER_PORT=8089
      - SPRING_PROFILES_ACTIVE=local
      - DB_PAYMENT=jdbc:postgresql://postgres:5432/mobility_platform?currentSchema=ipg
      - SECRETS_DBUSER=${POSTGRES_USER:-mobility_user}
      - SECRETS_DBPASS=${POSTGRES_PASSWORD:-mobility_password}
      - AMQ_HOST=rabbitmq
      - SECRETS_AMQUSER=${RABBITMQ_USER:-mobility_user}
      - SECRETS_AMQPASS=${RABBITMQ_PASSWORD:-mobility_password}
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8089/api/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    profiles:
      - backend

  # ============================================
  # FRONTEND SERVICE
  # ============================================

  # Frontend (React + Nginx)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: mobility-frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-3000}:80"
    networks:
      - mobility-network
    depends_on:
      api-gateway:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    profiles:
      - frontend

networks:
  mobility-network:
    driver: bridge
    name: mobility-network

volumes:
  postgres_data:
    name: mobility-postgres-data
  rabbitmq_data:
    name: mobility-rabbitmq-data
  rabbitmq_logs:
    name: mobility-rabbitmq-logs
  redis_data:
    name: mobility-redis-data
  pgadmin_data:
    name: mobility-pgadmin-data

